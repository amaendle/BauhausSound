<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bauhaus Sound Generator ‚Äì Advanced</title>
  <style>
    :root{
      --bg:#f2f2f2; --fg:#111; --muted:#666; --accent:#111;
      --red:#e63946; --blue:#1d3557; --yellow:#f1c40f; --black:#000; --white:#fff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--fg); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Fira Sans", Helvetica, Arial, sans-serif;
      display:flex; flex-direction:column; min-height:100vh;
    }
    header{
      padding:24px; display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      border-bottom:2px solid #ddd;
    }
    .title{font-weight:700; letter-spacing:.02em}
    .badge{display:inline-flex; gap:8px; align-items:center}
    .shape{width:16px; height:16px; display:inline-block}
    .sq{background:var(--red)}
    .ci{background:var(--yellow); border-radius:50%}
    .tr{width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:16px solid var(--blue)}
    main{display:grid; grid-template-columns: 1fr 360px; gap:16px; padding:16px; flex:1}
    canvas{width:100%; height:100%; background:linear-gradient(180deg,#fff, #eee)}
    .panel{background:#fff; border:2px solid #111; padding:12px; border-radius:12px; box-shadow:4px 4px 0 #111}
    fieldset{border:1px solid #ccc; border-radius:8px; padding:8px 10px; margin:0 0 10px 0}
    legend{font-weight:600}
    label{display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; margin:6px 0}
    input[type="range"]{width:160px}
    select, input[type="number"], input[type="checkbox"]{accent-color:#111}
    button{appearance:none; border:none; background:#111; color:#fff; padding:10px 14px; font-weight:700; border-radius:10px; box-shadow:3px 3px 0 #000; cursor:pointer}
    button.secondary{background:#fff; color:#111; border:2px solid #111}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .small{font-size:.875rem; color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="title">Bauhaus Sound Generator ‚Äì <span class="small">Generativ ¬∑ Offline ¬∑ Web Audio API</span></div>
    <div class="badge" aria-hidden="true">
      <span class="shape sq"></span>
      <span class="shape ci"></span>
      <span class="shape tr"></span>
    </div>
  </header>
  <main>
    <section class="panel" style="padding:0; overflow:hidden">
      <canvas id="viz" width="1200" height="600"></canvas>
    </section>
    <aside class="panel" aria-label="Steuerung">
      <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:8px">
        <button id="btnPlay">üé∂ Start</button>
        <button id="btnRandom" class="secondary">üé≤ Zufall</button>
      </div>

      <fieldset>
        <legend>Tempo & Takt</legend>
        <label>Tempo (BPM)
          <input id="bpm" type="range" min="40" max="160" value="80" />
        </label>
        <label>Schl√§ge pro Takt
          <input id="beatsPerBar" type="number" min="2" max="12" value="4" />
        </label>
      </fieldset>

      <fieldset>
        <legend>Tonleiter & Modulation</legend>
        <label>Grundton
          <select id="root">
            <option>C</option><option>C#</option><option>D</option><option>D#</option>
            <option>E</option><option>F</option><option>F#</option><option>G</option>
            <option>G#</option><option>A</option><option>A#</option><option>B</option>
          </select>
        </label>
        <label>Skala
          <select id="scale">
            <option value="major-pentatonic">Dur-Pentatonik</option>
            <option value="minor-pentatonic">Moll-Pentatonik</option>
            <option value="dorian">Dorisch</option>
            <option value="lydian">Lydisch</option>
            <option value="phrygian">Phrygisch</option>
          </select>
        </label>
        <label>Automodulation (Takte)
          <input id="modBars" type="number" min="0" step="1" value="8" />
        </label>
        <div class="small">0 = keine Automodulation</div>
      </fieldset>

      <fieldset>
        <legend>Stimmen</legend>
        <label>‚óºÔ∏é Quadrat (Perc) Lautst√§rke
          <input id="volSq" type="range" min="0" max="1" step="0.01" value="0.25" />
        </label>
        <label>Wellenform
          <select id="waveSq"><option>square</option><option>triangle</option><option>sawtooth</option><option>sine</option></select>
        </label>
        <hr />
        <label>‚óè Kreis (Melodie) Lautst√§rke
          <input id="volCi" type="range" min="0" max="1" step="0.01" value="0.2" />
        </label>
        <label>Wellenform
          <select id="waveCi"><option>sine</option><option>triangle</option><option>sawtooth</option><option>square</option></select>
        </label>
        <hr />
        <label>‚ñ≥ Dreieck (Fl√§che) Lautst√§rke
          <input id="volTr" type="range" min="0" max="1" step="0.01" value="0.15" />
        </label>
        <label>Wellenform
          <select id="waveTr"><option>triangle</option><option>sine</option><option>square</option><option>sawtooth</option></select>
        </label>
        <label>Pad-Dauer (s)
          <input id="padDur" type="number" min="0.5" step="0.1" value="1.5" />
        </label>
      </fieldset>

      <fieldset>
        <legend>Effekte</legend>
        <label>Filter-Cutoff (Hz)
          <input id="cutoff" type="range" min="200" max="6000" value="2000" />
        </label>
        <label>Delay-Mix
          <input id="delayMix" type="range" min="0" max="0.8" step="0.01" value="0.2" />
        </label>
        <label>Auto-LFO Filter
          <input id="lfo" type="checkbox" checked />
        </label>
      </fieldset>

      <div class="small">Tipp: Passe Tempo, Skala und Filter an ‚Äì alles l√§uft live weiter.</div>
    </aside>
  </main>

  <script>
  // ======== Utility: Notes & Scales ========
  const NOTE_INDEX = {C:0, 'C#':1, D:2, 'D#':3, E:4, F:5, 'F#':6, G:7, 'G#':8, A:9, 'A#':10, B:11};
  const A4 = 440;
  function midiToFreq(m){ return 440 * Math.pow(2, (m-69)/12); }
  function noteFreq(root, offsetSemis, octave=4){
    const rootIdx = NOTE_INDEX[root];
    const midi = 12*(octave+1) + rootIdx + offsetSemis;
    return midiToFreq(midi);
  }
  const SCALES = {
    'major-pentatonic':[0,2,4,7,9],
    'minor-pentatonic':[0,3,5,7,10],
    'dorian':[0,2,3,5,7,9,10],
    'lydian':[0,2,4,6,7,9,11],
    'phrygian':[0,1,3,5,7,8,10]
  };

  // ======== Audio Engine ========
  let ctx, master, analyser, filter, delay, delayGain, lfoOsc, lfoGain;
  let schedulerTimer=null, vizTimer=null;
  const state = {
    bpm: 80,
    beatsPerBar: 4,
    barCount: 0,
    nextNoteTime: 0,
    current16th: 0,
    lookahead: 25, // ms
    scheduleAheadTime: 0.1, // s
    isPlaying:false,
    // params
    root:'C', scale:'major-pentatonic', modBars:8,
    volSq:0.25, volCi:0.2, volTr:0.15,
    waveSq:'square', waveCi:'sine', waveTr:'triangle',
    padDur:1.5, cutoff:2000, delayMix:0.2, lfo:true
  };

  function initAudio(){
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    master = ctx.createGain(); master.gain.value = 0.9;
    filter = ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = state.cutoff; filter.Q.value = 0.707;
    delay = ctx.createDelay(1.0); delay.delayTime.value = 0.28;
    delayGain = ctx.createGain(); delayGain.gain.value = state.delayMix;
    analyser = ctx.createAnalyser(); analyser.fftSize = 2048;

    // LFO for filter
    lfoOsc = ctx.createOscillator(); lfoOsc.type = 'sine'; lfoOsc.frequency.value = 0.08; // very slow
    lfoGain = ctx.createGain(); lfoGain.gain.value = state.lfo ? 1200 : 0; // depth in Hz
    lfoOsc.connect(lfoGain).connect(filter.frequency);
    lfoOsc.start();

    // routing
    const preFX = ctx.createGain();
    preFX.connect(filter);
    filter.connect(delay);
    filter.connect(master);
    delay.connect(delayGain).connect(master);
    master.connect(analyser).connect(ctx.destination);

    engine.preFX = preFX;
  }

  const engine = { preFX:null };

  function schedule(){
    const secondsPer16th = 60.0 / state.bpm / 4.0;
    while(state.nextNoteTime < ctx.currentTime + state.scheduleAheadTime){
      const n = state.current16th;
      const time = state.nextNoteTime;
      // Schedule SQ (Perc) on every 8th (i.e., two 16ths) for a 1/8 note pulse
      if(n % 2 === 0){ playPerc(time); triggerViz('sq', time); }
      // Schedule CI (Melody) on beat starts (every 4 16ths)
      if(n % 4 === 0){ playMelody(time); triggerViz('ci', time); }
      // Schedule TR (Pad) on bar start
      if(n % (state.beatsPerBar*4) === 0){ playPad(time); triggerViz('tr', time); state.barCount++; maybeModulate(); }

      state.nextNoteTime += secondsPer16th;
      state.current16th = (n+1) % (state.beatsPerBar*4);
    }
  }

  function nextPitch(){
    const degrees = SCALES[state.scale];
    const deg = degrees[Math.floor(Math.random()*degrees.length)];
    // jitter up/down an octave sometimes
    const oct = Math.random()<0.15 ? 5 : 4;
    return noteFreq(state.root, deg, oct);
  }

  function chordPitches(){
    const degrees = SCALES[state.scale];
    // pick a root degree and stack thirds within scale
    const idx = Math.floor(Math.random()*degrees.length);
    const d1 = degrees[idx];
    const d2 = degrees[(idx+2)%degrees.length];
    const d3 = degrees[(idx+4)%degrees.length];
    return [d1,d2,d3].map((d,i)=> noteFreq(state.root, d, 3 + (i>0?0:0)));
  }

  function env(time, duration, peak=0.25){
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.0001, time);
    g.gain.exponentialRampToValueAtTime(peak, time+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, time+duration);
    return g;
  }

  function playPerc(time){
    const o = ctx.createOscillator(); o.type = state.waveSq; o.frequency.setValueAtTime(800, time);
    const g = env(time, 0.06, state.volSq);
    o.connect(g).connect(engine.preFX);
    o.start(time); o.stop(time+0.06);
  }

  function playMelody(time){
    const f = nextPitch();
    const o = ctx.createOscillator(); o.type = state.waveCi; o.frequency.setValueAtTime(f, time);
    const g = env(time, 0.22, state.volCi);
    // gentle portamento
    if(Math.random()<0.4){ o.frequency.linearRampToValueAtTime(f* (Math.random()<0.5? 2:0.5), time+0.18); }
    o.connect(g).connect(engine.preFX);
    o.start(time); o.stop(time+0.24);
  }

  function playPad(time){
    const dur = Math.max(0.5, Number(document.getElementById('padDur').value)||state.padDur);
    const pitches = chordPitches();
    pitches.forEach((f,i)=>{
      const o = ctx.createOscillator(); o.type = state.waveTr; o.frequency.setValueAtTime(f, time);
      const g = env(time, dur, state.volTr * (i===0?1:0.7));
      o.connect(g).connect(engine.preFX);
      o.start(time); o.stop(time+dur);
    });
  }

  function maybeModulate(){
    const bars = Number(document.getElementById('modBars').value)||state.modBars;
    if(!bars || bars<=0) return;
    if(state.barCount % bars === 0){
      // rotate root by perfect fourth (5 semis) or fifth (7 semis)
      const roots = Object.keys(NOTE_INDEX);
      const currentIdx = roots.indexOf(state.root);
      const step = Math.random()<0.5? 5:7; // circle of fourths/fifths
      const newIdx = (currentIdx + step) % 12;
      state.root = roots[newIdx];
      document.getElementById('root').value = state.root;
      // slight filter sweep as a transition
      const target = Math.max(400, Math.min(6000, filter.frequency.value * (Math.random()<0.5?1.5:0.8)));
      filter.frequency.linearRampToValueAtTime(target, ctx.currentTime+2);
      flashBanner(`${state.root} ‚Äì Modulation`);
    }
  }

  // ======== Transport ========
  function start(){
    if(state.isPlaying) return;
    if(!ctx) initAudio();
    state.isPlaying = true;
    state.nextNoteTime = ctx.currentTime + 0.1;
    state.current16th = 0; state.barCount = 0;
    schedulerTimer = setInterval(schedule, state.lookahead);
    startViz();
  }
  function stop(){
    state.isPlaying = false;
    if(schedulerTimer) clearInterval(schedulerTimer);
    if(vizTimer) cancelAnimationFrame(vizTimer);
    try{ ctx && ctx.close(); }catch(e){}
    ctx = null;
  }

  // ======== UI Wiring ========
  const $ = (id)=>document.getElementById(id);
  $('btnPlay').addEventListener('click',()=>{
    if(!state.isPlaying){ start(); $('btnPlay').textContent='‚è∏Ô∏è Pause'; }
    else { stop(); $('btnPlay').textContent='üé∂ Start'; }
  });
  $('btnRandom').addEventListener('click',()=>{
    $('bpm').value = String(60 + Math.floor(Math.random()*80));
    $('beatsPerBar').value = [3,4,5,6][Math.floor(Math.random()*4)];
    $('root').selectedIndex = Math.floor(Math.random()*12);
    $('scale').selectedIndex = Math.floor(Math.random()*5);
    $('modBars').value = [0,4,8,12][Math.floor(Math.random()*4)];
    $('volSq').value = (Math.random()*0.5).toFixed(2);
    $('volCi').value = (Math.random()*0.5).toFixed(2);
    $('volTr').value = (Math.random()*0.5).toFixed(2);
    $('waveSq').selectedIndex = Math.floor(Math.random()*4);
    $('waveCi').selectedIndex = Math.floor(Math.random()*4);
    $('waveTr').selectedIndex = Math.floor(Math.random()*4);
    $('cutoff').value = String(400 + Math.floor(Math.random()*4600));
    $('delayMix').value = (Math.random()*0.6).toFixed(2);
    applyUI();
  });

  function applyUI(){
    state.bpm = Number($('bpm').value);
    state.beatsPerBar = Math.max(2, Math.min(12, Number($('beatsPerBar').value)||4));
    state.root = $('root').value; state.scale = $('scale').value; state.modBars = Number($('modBars').value)||0;
    state.volSq = Number($('volSq').value); state.waveSq = $('waveSq').value;
    state.volCi = Number($('volCi').value); state.waveCi = $('waveCi').value;
    state.volTr = Number($('volTr').value); state.waveTr = $('waveTr').value; state.padDur = Number($('padDur').value)||1.5;
    state.cutoff = Number($('cutoff').value); state.delayMix = Number($('delayMix').value); state.lfo = $('lfo').checked;
    if(filter){ filter.frequency.setTargetAtTime(state.cutoff, ctx.currentTime, 0.05); }
    if(delayGain){ delayGain.gain.setTargetAtTime(state.delayMix, ctx.currentTime, 0.1); }
    if(lfoGain){ lfoGain.gain.setValueAtTime(state.lfo ? 1200 : 0, ctx.currentTime); }
  }
  ['bpm','beatsPerBar','root','scale','modBars','volSq','waveSq','volCi','waveCi','volTr','waveTr','padDur','cutoff','delayMix','lfo']
    .forEach(id=> $(id).addEventListener('input', applyUI));

  // ======== Visualization ========
  const canvas = document.getElementById('viz');
  const ctx2d = canvas.getContext('2d');
  let w = canvas.width, h = canvas.height;
  window.addEventListener('resize', ()=>{ canvas.width = canvas.clientWidth*2; canvas.height = canvas.clientHeight*2; w=canvas.width; h=canvas.height; });
  window.dispatchEvent(new Event('resize'));

  const vizState = { pulses:[], banner:null };
  function triggerViz(kind, time){
    vizState.pulses.push({ kind, t: time, x: Math.random()*w, y: Math.random()*h, life: 0 });
  }
  function flashBanner(text){ vizState.banner = { text, until: performance.now()+1800 }; }

  function startViz(){
    const data = new Uint8Array(analyser.frequencyBinCount);
    function loop(){
      vizTimer = requestAnimationFrame(loop);
      analyser.getByteFrequencyData(data);
      const avg = data.slice(0,128).reduce((a,b)=>a+b,0)/128/255; // rough energy
      // background
      ctx2d.fillStyle = '#ffffff'; ctx2d.fillRect(0,0,w,h);

      // grid aesthetic
      ctx2d.save();
      ctx2d.globalAlpha = 0.05;
      const step = 40;
      ctx2d.strokeStyle = '#000000';
      for(let x=0;x<w;x+=step){ ctx2d.beginPath(); ctx2d.moveTo(x,0); ctx2d.lineTo(x,h); ctx2d.stroke(); }
      for(let y=0;y<h;y+=step){ ctx2d.beginPath(); ctx2d.moveTo(0,y); ctx2d.lineTo(w,y); ctx2d.stroke(); }
      ctx2d.restore();

      // pulses
      const now = ctx? ctx.currentTime : 0;
      vizState.pulses = vizState.pulses.filter(p=> (now - p.t) < 2.0);
      vizState.pulses.forEach(p=>{
        const age = Math.max(0, now - p.t);
        const scale = 1 + age*2.5;
        ctx2d.save();
        if(p.kind==='sq'){ ctx2d.fillStyle = '#e63946'; const s = 18*scale; ctx2d.fillRect(p.x - s/2, p.y - s/2, s, s); }
        if(p.kind==='ci'){ ctx2d.fillStyle = '#f1c40f'; ctx2d.beginPath(); ctx2d.arc(p.x, p.y, 10*scale, 0, Math.PI*2); ctx2d.fill(); }
        if(p.kind==='tr'){
          ctx2d.fillStyle = '#1d3557'; const s = 24*scale;
          ctx2d.beginPath();
          ctx2d.moveTo(p.x, p.y - s/2);
          ctx2d.lineTo(p.x - s/2, p.y + s/2);
          ctx2d.lineTo(p.x + s/2, p.y + s/2);
          ctx2d.closePath(); ctx2d.fill();
        }
        ctx2d.restore();
      });

      // central reactive shapes
      const centerX = w*0.5, centerY = h*0.5;
      const base = Math.min(w,h)*0.18;
      // square (beat)
      ctx2d.save();
      ctx2d.translate(centerX - base*1.2, centerY);
      const sqSize = base * (0.9 + avg*0.6);
      ctx2d.fillStyle = '#e63946';
      ctx2d.fillRect(-sqSize/2, -sqSize/2, sqSize, sqSize);
      ctx2d.restore();
      // circle (melody)
      ctx2d.save();
      ctx2d.translate(centerX, centerY);
      const radius = base * (0.8 + avg*0.8);
      ctx2d.fillStyle = '#f1c40f';
      ctx2d.beginPath(); ctx2d.arc(0,0,radius,0,Math.PI*2); ctx2d.fill();
      ctx2d.restore();
      // triangle (pad)
      ctx2d.save();
      ctx2d.translate(centerX + base*1.2, centerY);
      const t = base * (0.9 + avg*0.5);
      ctx2d.fillStyle = '#1d3557';
      ctx2d.beginPath(); ctx2d.moveTo(0, -t/1.1); ctx2d.lineTo(-t/1.1, t/1.1); ctx2d.lineTo(t/1.1, t/1.1); ctx2d.closePath(); ctx2d.fill();
      ctx2d.restore();

      // banner
      if(vizState.banner && performance.now() < vizState.banner.until){
        ctx2d.save();
        ctx2d.globalAlpha = 0.85;
        ctx2d.fillStyle = '#000';
        const pad = 16; const txt = vizState.banner.text;
        ctx2d.font = 'bold 40px system-ui';
        const tw = ctx2d.measureText(txt).width;
        ctx2d.fillRect((w-tw)/2 - pad, 40, tw + pad*2, 64);
        ctx2d.fillStyle = '#fff';
        ctx2d.fillText(txt, (w-tw)/2, 85);
        ctx2d.restore();
      }
    }
    loop();
  }

  // Initialize UI defaults
  applyUI();
  </script>
</body>
</html>
